#$Id: Giovanni-WorldLongitude_GOCART.t,v 1.2 2014/02/27 21:53:23 csmit Exp $
#-@@@ GIOVANNI,Version $Name:  $

# Before `make install' is performed this script should be runnable with
# `make test'. After `make install' it should work as `perl Giovanni-Algorithm-GridNormalizer.t'

#########################

# change 'tests => 1' to 'tests => last_test_to_print';

use Test::More tests => 3;
BEGIN { use_ok('Giovanni::WorldLongitude') }

#########################

use File::Temp qw/ tempdir /;
use Giovanni::Data::NcFile;
use Giovanni::Logger;

# create a working directory
my $dir = tempdir( CLEANUP => 1 );

# create the input data file
my ( $inCdl, $correctCdl ) = readCdlData();

my $dataFile
    = "$dir/timeAvg.G4P0_1DA_2D_du_aot_006_tauf2d_du_00550.20030101-20030101.160E_50S_171W_29S.nc";
Giovanni::Data::NcFile::write_netcdf_file( $dataFile, $inCdl )
    or die "Unable to write input file.";

# create a logger
my $logger = Giovanni::Logger->new(
    session_dir       => $dir,
    manifest_filename => "mfst.blah+whatever.xml"
);

my $outFile = "$dir/out.nc";
Giovanni::WorldLongitude::normalize(
    logger       => $logger,
    in           => [$dataFile],
    out          => [$outFile],
    startPercent => 50,
    endPercent   => 100,
    sessionDir   => $dir,
);

ok( -e $outFile, "Output file exists" ) or die;

# write the correct data file
my $correctNc
    = "$dir/timeAvgWorldLon.G4P0_1DA_2D_du_aot_006_tauf2d_du_00550.20030101-20030101.160E_50S_171W_29S.nc";
Giovanni::Data::NcFile::write_netcdf_file( $correctNc, $correctCdl )
    or die "Unable to write test output file.";

my $out
    = Giovanni::Data::NcFile::diff_netcdf_files( $outFile, $correctNc, $dir,
    "history" );

is( $out, 0, "Same output: $out" );

sub readCdlData {

    # read block at __DATA__ and write to a CDL file
    #(stolen from Chris...)
    my @cdldata;
    while (<DATA>) {
        push @cdldata, $_;
    }
    my $allCdf = join( '', @cdldata );

    # now divide up
    my @cdl = ( $allCdf =~ m/(netcdf .*?\}\n)/gs );
    return @cdl;
}

#http://s4ptu-ts2.ecs.nasa.gov/giovanni/#service=INTERACTIVE_MAP&starttime=2003-01-01T00:00:00Z&endtime=2003-01-01T23:59:59Z&bbox=159.7852,-50.4141,-170.6836,-28.6172&data=G4P0_1DA_2D_du_aot_006_tauf2d_du_00550&dataKeyword=GOCART
__DATA__
netcdf timeAvg.G4P0_1DA_2D_du_aot_006_tauf2d_du_00550.20030101-20030101.160E_50S_171W_29S {
dimensions:
    lat = 11 ;
    lon = 12 ;
variables:
    float G4P0_1DA_2D_du_aot_006_tauf2d_du_00550(lat, lon) ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:_FillValue = -9999.f ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:long_name = "Aerosol Optical Depth of Dust (fine) 550 nm, GOCART model, 2.0 x 2.5 deg." ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:units = "1" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:cell_methods = "time: mean" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:coordinates = "time lat lon" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:standard_name = "tauf2d_du_00550" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:quantity_type = "Component Aerosol Optical Depth" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:product_short_name = "G4P0_1DA_2D_du_aot" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:product_version = "006" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:latitude_resolution = 2. ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:longitude_resolution = 2.5 ;
    float lat(lat) ;
        lat:borders = "ilat" ;
        lat:long_name = "Latitude" ;
        lat:standard_name = "latitude" ;
        lat:units = "degrees_north" ;
    float lon(lon) ;
        lon:borders = "ilon" ;
        lon:long_name = "Longitude" ;
        lon:standard_name = "longitude" ;
        lon:units = "degrees_east" ;

// global attributes:
        :Conventions = "CF-1.4" ;
        :NCO = "4.3.1" ;
        :nco_openmp_thread_number = 1 ;
        :start_time = "2003-01-01T00:00:00Z" ;
        :end_time = "2003-01-01T23:59:59Z" ;
        :title = "G4P0_1DA_2D_du_aot_006_tauf2d_du_00550 Averaged over 2003-01-01 to 2003-01-01" ;
data:

 G4P0_1DA_2D_du_aot_006_tauf2d_du_00550 =
  0.007696498, 0.006549134, 0.006028154, 0.005966838, 0.006432399, 
    0.00759215, 0.009020117, 0.009596908, 0.009463165, 0.008333757, 
    0.006498666, 0.004839468,
  0.003793574, 0.003100157, 0.002697144, 0.002678986, 0.003098264, 
    0.003831252, 0.00501444, 0.007025104, 0.008840204, 0.009533844, 
    0.009526893, 0.008310743,
  0.002096575, 0.00159282, 0.001542974, 0.001756091, 0.002155073, 
    0.002785962, 0.003558017, 0.004829759, 0.006962035, 0.008902243, 
    0.00992278, 0.01022564,
  0.001215908, 0.001086528, 0.001146033, 0.001581398, 0.001976669, 
    0.002657265, 0.003744566, 0.00520258, 0.007045577, 0.008707258, 
    0.009853097, 0.01049158,
  0.0009331549, 0.0008133498, 0.0009969737, 0.00179743, 0.002600568, 
    0.002756526, 0.00385119, 0.004724914, 0.005784277, 0.007142966, 
    0.00842576, 0.009425019,
  0.0007603426, 0.0006654931, 0.0008408279, 0.001768535, 0.003202363, 
    0.003878532, 0.004015889, 0.004337121, 0.004812129, 0.005413043, 
    0.006076285, 0.007004433,
  0.00066726, 0.0005427308, 0.0005966092, 0.001056089, 0.002422812, 
    0.003892257, 0.004218161, 0.004533788, 0.004990413, 0.005358277, 
    0.005688132, 0.006132307,
  0.0005720096, 0.0004558779, 0.0005046952, 0.0006110069, 0.0008360647, 
    0.001828, 0.002984341, 0.003557706, 0.004010778, 0.004523856, 
    0.004955674, 0.005279295,
  0.0004924787, 0.0003754878, 0.0004019005, 0.0004590698, 0.0005061222, 
    0.000574715, 0.0008392775, 0.001376185, 0.002209638, 0.002780212, 
    0.003042067, 0.003313821,
  0.0004519809, 0.0003291469, 0.0003268518, 0.0003640681, 0.0003898778, 
    0.0003954687, 0.0004155441, 0.0004738929, 0.0007040006, 0.001377115, 
    0.001683401, 0.001547141,
  0.0004618272, 0.0003174389, 0.00027749, 0.0003036486, 0.0003614963, 
    0.0003845643, 0.0003849913, 0.0003787918, 0.0003947318, 0.0005461709, 
    0.0008936994, 0.001055246 ;

 lat = -50, -48, -46, -44, -42, -40, -38, -36, -34, -32, -30 ;

 lon = 160, 162.5, 165, 167.5, 170, 172.5, 175, 177.5, -180, -177.5, -175, 
    -172.5 ;
}
netcdf timeAvgWorldLon.G4P0_1DA_2D_du_aot_006_tauf2d_du_00550.20030101-20030101.160E_50S_171W_29S {
dimensions:
    lat = 11 ;
    lon = 144 ;
variables:
    float G4P0_1DA_2D_du_aot_006_tauf2d_du_00550(lat, lon) ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:_FillValue = -9999.f ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:cell_methods = "time: mean" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:coordinates = "time lat lon" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:latitude_resolution = 2. ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:long_name = "Aerosol Optical Depth of Dust (fine) 550 nm, GOCART model, 2.0 x 2.5 deg." ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:longitude_resolution = 2.5 ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:product_short_name = "G4P0_1DA_2D_du_aot" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:product_version = "006" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:quantity_type = "Component Aerosol Optical Depth" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:standard_name = "tauf2d_du_00550" ;
        G4P0_1DA_2D_du_aot_006_tauf2d_du_00550:units = "1" ;
    float lat(lat) ;
        lat:borders = "ilat" ;
        lat:long_name = "Latitude" ;
        lat:standard_name = "latitude" ;
        lat:units = "degrees_north" ;
    float lon(lon) ;
        lon:borders = "ilon" ;
        lon:long_name = "Longitude" ;
        lon:standard_name = "longitude" ;
        lon:units = "degrees_east" ;

// global attributes:
        :Conventions = "CF-1.4" ;
        :NCO = "4.3.1" ;
        :nco_openmp_thread_number = 1 ;
        :start_time = "2003-01-01T00:00:00Z" ;
        :end_time = "2003-01-01T23:59:59Z" ;
        :title = "G4P0_1DA_2D_du_aot_006_tauf2d_du_00550 Averaged over 2003-01-01 to 2003-01-01" ;
data:

 G4P0_1DA_2D_du_aot_006_tauf2d_du_00550 =
  0.009463165, 0.008333757, 0.006498666, 0.004839468, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.007696498, 0.006549134, 0.006028154, 0.005966838, 
    0.006432399, 0.00759215, 0.009020117, 0.009596908,
  0.008840204, 0.009533844, 0.009526893, 0.008310743, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.003793574, 0.003100157, 0.002697144, 0.002678986, 
    0.003098264, 0.003831252, 0.00501444, 0.007025104,
  0.006962035, 0.008902243, 0.00992278, 0.01022564, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.002096575, 0.00159282, 0.001542974, 0.001756091, 
    0.002155073, 0.002785962, 0.003558017, 0.004829759,
  0.007045577, 0.008707258, 0.009853097, 0.01049158, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.001215908, 0.001086528, 0.001146033, 0.001581398, 
    0.001976669, 0.002657265, 0.003744566, 0.00520258,
  0.005784277, 0.007142966, 0.00842576, 0.009425019, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.0009331549, 0.0008133498, 0.0009969737, 0.00179743, 
    0.002600568, 0.002756526, 0.00385119, 0.004724914,
  0.004812129, 0.005413043, 0.006076285, 0.007004433, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.0007603426, 0.0006654931, 0.0008408279, 0.001768535, 
    0.003202363, 0.003878532, 0.004015889, 0.004337121,
  0.004990413, 0.005358277, 0.005688132, 0.006132307, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.00066726, 0.0005427308, 0.0005966092, 0.001056089, 
    0.002422812, 0.003892257, 0.004218161, 0.004533788,
  0.004010778, 0.004523856, 0.004955674, 0.005279295, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.0005720096, 0.0004558779, 0.0005046952, 0.0006110069, 
    0.0008360647, 0.001828, 0.002984341, 0.003557706,
  0.002209638, 0.002780212, 0.003042067, 0.003313821, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, 0.0004924787, 0.0003754878, 0.0004019005, 0.0004590698, 
    0.0005061222, 0.000574715, 0.0008392775, 0.001376185,
  0.0007040006, 0.001377115, 0.001683401, 0.001547141, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, 0.0004519809, 0.0003291469, 0.0003268518, 0.0003640681, 
    0.0003898778, 0.0003954687, 0.0004155441, 0.0004738929,
  0.0003947318, 0.0005461709, 0.0008936994, 0.001055246, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 
    _, _, _, _, _, 0.0004618272, 0.0003174389, 0.00027749, 0.0003036486, 
    0.0003614963, 0.0003845643, 0.0003849913, 0.0003787918 ;

 lat = -50, -48, -46, -44, -42, -40, -38, -36, -34, -32, -30 ;

 lon = -180, -177.5, -175, -172.5, -170, -167.5, -165, -162.5, -160, -157.5, 
    -155, -152.5, -150, -147.5, -145, -142.5, -140, -137.5, -135, -132.5, 
    -130, -127.5, -125, -122.5, -120, -117.5, -115, -112.5, -110, -107.5, 
    -105, -102.5, -100, -97.5, -95, -92.5, -90, -87.5, -85, -82.5, -80, 
    -77.5, -75, -72.5, -70, -67.5, -65, -62.5, -60, -57.5, -55, -52.5, -50, 
    -47.5, -45, -42.5, -40, -37.5, -35, -32.5, -30, -27.5, -25, -22.5, -20, 
    -17.5, -15, -12.5, -10, -7.5, -5, -2.5, 0, 2.5, 5, 7.5, 10, 12.5, 15, 
    17.5, 20, 22.5, 25, 27.5, 30, 32.5, 35, 37.5, 40, 42.5, 45, 47.5, 50, 
    52.5, 55, 57.5, 60, 62.5, 65, 67.5, 70, 72.5, 75, 77.5, 80, 82.5, 85, 
    87.5, 90, 92.5, 95, 97.5, 100, 102.5, 105, 107.5, 110, 112.5, 115, 117.5, 
    120, 122.5, 125, 127.5, 130, 132.5, 135, 137.5, 140, 142.5, 145, 147.5, 
    150, 152.5, 155, 157.5, 160, 162.5, 165, 167.5, 170, 172.5, 175, 177.5 ;
}
